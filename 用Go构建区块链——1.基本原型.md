### ç”¨Goæ„å»ºåŒºå—é“¾â€”â€”1.åŸºæœ¬åŸå‹

æœ¬ç¯‡å¼€å§‹è¿›å…¥"ç”¨Goæ„å»ºåŒºå—é“¾"ç³»åˆ—ï¼Œä¸»è¦å¯¹åŸæ–‡è¿›è¡Œç¿»è¯‘ã€‚å¯¹åº”åŸæ–‡å¦‚ä¸‹ï¼š

[Building Blockchain in Go. Part 1: Basic Prototype](https://jeiwan.cc/posts/building-blockchain-in-go-part-1/)

è¯ä¸å¤šè¯´ï¼Œå¼€å§‹è¿›å…¥æ­£æ–‡

#### 1ã€ä»‹ç»

åŒºå—é“¾æ˜¯21ä¸–çºªæœ€å…·é©å‘½æ€§çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå®ƒä»åœ¨é€æ­¥å‘å±•ä¸­ï¼Œå¹¶ä¸”å…¶æ½œåŠ›è¿˜æœªè¢«å……åˆ†è®¤è¯†ã€‚æœ¬è´¨ä¸Šï¼ŒåŒºå—é“¾åªæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“è€Œå·²ã€‚ä½†æ˜¯ï¼Œå®ƒçš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºå®ƒä¸æ˜¯ä¸€ä¸ªç§æœ‰çš„æ•°æ®åº“ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¬å…±çš„ï¼Œå³æ¯ä¸ªä½¿ç”¨å®ƒçš„äººéƒ½æ‹¥æœ‰å®ƒçš„å…¨éƒ¨æˆ–éƒ¨åˆ†å‰¯æœ¬ã€‚åªæœ‰å¾—åˆ°å…¶ä»–æ•°æ®åº“ç®¡ç†å‘˜çš„åŒæ„ï¼Œæ–°çš„è®°å½•æ‰èƒ½è¢«åŠ å…¥ã€‚æ­£å› ä¸ºç”±æ­¤åŒºå—é“¾ï¼Œæ‰ä½¿å¾—åŠ å¯†è´§å¸å’Œæ™ºèƒ½åˆçº¦æˆä¸ºå¯èƒ½ã€‚

åœ¨æœ¬ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªåŸºäºç®€å•åŒºå—é“¾å®ç°çš„ç®€å•åŠ å¯†è´§å¸ã€‚

#### 2ã€åŒºå—

æˆ‘ä»¬ä»"åŒºå—é“¾"çš„"åŒºå—"éƒ¨åˆ†å¼€å§‹ã€‚åœ¨åŒºå—é“¾ä¸­ï¼Œå®ƒå­˜å‚¨æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œæ¯”ç‰¹å¸å—å­˜å‚¨äº¤æ˜“ä¿¡æ¯ï¼Œè¿™æ˜¯æ‰€æœ‰åŠ å¯†è´§å¸çš„æœ¬è´¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒåŒºå—è¿˜åŒ…å«ä¸€äº›æŠ€æœ¯ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·ã€å½“å‰æ—¶é—´æˆ³å’Œä¸Šä¸€ä¸ªåŒºå—çš„å“ˆå¸Œã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šå®ç°åŒºå—é“¾ä¸­æè¿°çš„åŒºå—ï¼Œä¹Ÿä¸ä¼šæ˜¯æ¯”ç‰¹å¸æŠ€æœ¯è§„èŒƒä¸­çš„åŒºå—ï¼Œè€Œæ˜¯ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼Œå…¶ä¸­åªåŒ…å«é‡è¦ä¿¡æ¯ã€‚è¿™æ˜¯å®ƒçš„æ ·å­ï¼š

```go
type Block struct {
	Timestamp     int64
	Data          []byte
	PrevBlockHash []byte
	Hash          []byte
}
```

`Timestamp` æ˜¯å½“å‰æ—¶é—´æˆ³(åŒºå—è¢«åˆ›å»ºæ—¶),  `Data` æ˜¯åŒ…å«åœ¨åŒºå—ä¸­çš„å®é™…æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œè€Œ `Hash` æ˜¯å½“å‰åŒºå—çš„å“ˆå¸Œã€‚åœ¨æ¯”ç‰¹å¸æŠ€æœ¯è§„èŒƒä¸­ï¼Œ `Timestamp`ï¼Œ`PrevBlockHash` å’Œ `Hash` æ˜¯åŒºå—å¤´ï¼Œå®ƒä»¬å½¢æˆä¸€ä¸ªå•ç‹¬çš„æ•°æ®ç»“æ„ï¼Œè€Œäº¤æ˜“ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯æ•°æ®ï¼‰æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬è¿™é‡Œç®€å•èµ·è§ï¼Œæ··åˆåœ¨ä¸€èµ·äº†ã€‚

é‚£ä¹ˆï¼Œæ€ä¹ˆè®¡ç®—å“ˆå¸Œå‘¢ï¼Ÿå“ˆå¸Œçš„è®¡ç®—æ–¹å¼åœ¨åŒºå—é“¾ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œæ­£æ˜¯è¿™ä¸€ç‰¹æ€§ä½¿å¾—åŒºå—é“¾æ›´åŠ å®‰å…¨ã€‚é—®é¢˜æ˜¯è®¡ç®—å“ˆå¸Œæ˜¯ä¸€ä¸ªéš¾ä»¥è®¡ç®—çš„æ“ä½œï¼Œå³ä½¿åœ¨å¾ˆå¿«çš„è®¡ç®—æœºä¸Šä¹Ÿéœ€è¦è¯è´¹å¾ˆå¤šæ—¶é—´ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆäººä»¬è´­ä¹°å¼ºå¤§çš„GPUæ¥æŒ–æ¯”ç‰¹å¸ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªæ¶æ„ä¸Šæœ‰æ„ä¸ºä¹‹çš„è®¾è®¡ï¼Œè¿™ä½¿å¾—æ·»åŠ æ–°çš„åŒºå—å˜å¾—å›°éš¾ï¼Œä»è€Œé˜»æ­¢æ·»åŠ åçš„ä¿®æ”¹ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­å»è®¨è®ºå’Œå®ç°è¿™ä¸ªæœºåˆ¶ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åªå–äº†åŒºå—å­—æ®µï¼Œå¹¶æŠŠå®ƒä»¬æ‹¼æ¥èµ·æ¥ï¼Œå¹¶åœ¨è¿æ¥çš„ç»„åˆä¸Šè®¡ç®—SHA-256å“ˆå¸Œã€‚ è®©æˆ‘ä»¬åœ¨ `SetHash` æ–¹æ³•ä¸­å®Œæˆè¿™äº›æ“ä½œï¼š

```go
func (b *Block) SetHash() {
	timestamp := []byte(strconv.FormatInt(b.Timestamp, 10))
	headers := bytes.Join([][]byte{b.PrevBlockHash, b.Data, timestamp}, []byte{})
	hash := sha256.Sum256(headers)

	b.Hash = hash[:]
}
```

æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§Golangçš„çº¦å®šï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå°†ç®€åŒ–åˆ›å»ºåŒºå—çš„å‡½æ•°ï¼š

```go
func NewBlock(data string, prevBlockHash []byte) *Block {
	block := &Block{time.Now().Unix(), []byte(data), prevBlockHash, []byte{}}
	block.SetHash()
	return block
}
```

å¥½äº†ï¼Œè¿™å°±æ˜¯åŒºå—ï¼

#### 3ã€åŒºå—é“¾

ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŒºå—é“¾ã€‚å…¶æœ¬è´¨åŒºå—é“¾ä»…ä»…æ˜¯ä¸€ä¸ªå…·æœ‰ç‰¹å®šç»“æ„çš„æ•°æ®åº“ï¼šå®ƒæ˜¯ä¸€ä¸ªæœ‰åºçš„ï¼Œå°¾éƒ¨ç›¸è¿çš„é“¾è¡¨ã€‚è¿™æ„å‘³ç€åŒºå—æŒ‰ç…§æ’å…¥çš„é¡ºåºæ¥å­˜å‚¨ï¼Œå¹¶ä¸”æ¯ä¸ªåŒºå—éƒ½é“¾æ¥ç€å‰ä¸€ä¸ªåŒºå—ã€‚è¯¥ç»“æ„å…è®¸å¿«é€Ÿè·å–é“¾ä¸­çš„æœ€æ–°å—ï¼Œå¹¶é€šè¿‡å…¶å“ˆå¸Œï¼ˆæœ‰æ•ˆï¼‰è·å–åŒºå—ã€‚

åœ¨Golangä¸­ï¼Œè¿™ä¸ªç»“æ„å¯ä»¥é€šè¿‡ä½¿ç”¨arrayå’Œmapæ¥å®ç°ï¼šarrayå­˜å‚¨æœ‰åºçš„å“ˆå¸Œ (Golangä¸­ï¼Œarrayæ˜¯æœ‰åºçš„)ï¼Œå¹¶ä¸” map ç»“æ„å¯ä»¥ä¿å­˜ `hash -> block` çš„åŒ¹é…ä¿¡æ¯ã€‚ä½†åœ¨æˆ‘ä»¬çš„åŒºå—é“¾åŸå‹ä¸­ï¼Œæˆ‘ä»¬åªä¼šä½¿ç”¨ä¸€ä¸ªarrayï¼Œå› ä¸ºæˆ‘ä»¬æš‚æ—¶å¹¶ä¸éœ€è¦é€šè¿‡ å“ˆå¸Œæ¥è·å–åŒºå—ä¿¡æ¯ã€‚

```go
type Blockchain struct {
  blocks []*Block
}
```

è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€å—åŒºå—é“¾ï¼æˆ‘ä»æœªæƒ³è¿‡å®ƒä¼šå¦‚æ­¤è½»æ¾ğŸ˜‰

ç°åœ¨ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç»™å®ƒæ·»åŠ ä¸€ä¸ªåŒºå—ï¼š

```go
func (bc *Blockchain) AddBlock(data string) {
	prevBlock := bc.blocks[len(bc.blocks)-1]
	newBlock := NewBlock(data, prevBlock.Hash)
	bc.blocks = append(bc.blocks, newBlock)
}
```

å°±è¿™æ ·ï¼è¿˜æ˜¯ï¼Ÿ

è¦æ·»åŠ æ–°çš„åŒºå—ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·²å­˜åœ¨çš„åŒºå—ï¼Œç„¶è€Œæˆ‘ä»¬çš„åŒºå—é“¾ä¸Šè¿˜æ²¡æœ‰ä¸€ä¸ªåŒºå—ï¼å› æ­¤ï¼Œåœ¨ä»»ä½•åŒºå—é“¾ä¸­ï¼Œå¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªåŒºå—ï¼Œè€Œè¿™ä¸ªåŒºå—æ˜¯é“¾ä¸­çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç§°ä¸ºåˆ›ä¸–åŒºå—ã€‚è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªåˆ›å»ºåˆ›ä¸–åŒºå—çš„å‡½æ•°ï¼š

```go
func NewGenesisBlock() *Block {
	return NewBlock("Genesis Block", []byte{})
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªåˆ›å»ºåŒ…å«åˆ›ä¸–åŒºå—çš„åŒºå—é“¾çš„å‡½æ•°ï¼š

```go
func NewBlockchain() *Blockchain {
	return &Blockchain{[]*Block{NewGenesisBlock()}}
}
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹åŒºå—é“¾æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```go
func main() {
	bc := NewBlockchain()

	bc.AddBlock("Send 1 BTC to Ivan")
	bc.AddBlock("Send 2 more BTC to Ivan")

	for _, block := range bc.blocks {
		fmt.Printf("Prev. hash: %x\n", block.PrevBlockHash)
		fmt.Printf("Data: %s\n", block.Data)
		fmt.Printf("Hash: %x\n", block.Hash)
		fmt.Println()
	}
}
```

è¾“å‡ºï¼š

```
Prev. hash:
Data: Genesis Block
Hash: aff955a50dc6cd2abfe81b8849eab15f99ed1dc333d38487024223b5fe0f1168

Prev. hash: aff955a50dc6cd2abfe81b8849eab15f99ed1dc333d38487024223b5fe0f1168
Data: Send 1 BTC to Ivan
Hash: d75ce22a840abb9b4e8fc3b60767c4ba3f46a0432d3ea15b71aef9fde6a314e1

Prev. hash: d75ce22a840abb9b4e8fc3b60767c4ba3f46a0432d3ea15b71aef9fde6a314e1
Data: Send 2 more BTC to Ivan
Hash: 561237522bb7fcfbccbc6fe0e98bbbde7427ffe01c6fb223f7562288ca2295d1
```

æ²¡é”™ï¼Œå°±è¿™æ ·ï¼

#### 4ã€æ€»ç»“

æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„åŒºå—é“¾åŸå‹ï¼šå®ƒåªæ˜¯ä¸€ä¸ªåŒ…å«æœ‰åŒºå—çš„æ•°ç»„ï¼Œæ¯ä¸ªåŒºå—å’Œå‰ä¸€ä¸ªç›¸è¿æ¥ã€‚çœŸå®çš„åŒºå—é“¾æ¯”è¿™ä¸ªå¤æ‚å¾—å¤šã€‚åœ¨æˆ‘ä»¬çš„åŒºå—é“¾ä¸­ï¼Œæ·»åŠ æ–°çš„åŒºå—éå¸¸ç®€å•è€Œä¸”å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨çœŸå®çš„åŒºå—é“¾ä¸­æ·»åŠ æ–°åŒºå—éœ€è¦åšå¾ˆå¤šå·¥ä½œï¼šä¸€æ˜¯éœ€è¦åœ¨æ·»åŠ åŒºå—å‰åšä¸€äº›å¤æ‚çš„è®¡ç®—æ¥è·å–æ·»åŠ åŒºå—çš„æƒé™(è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º `å·¥ä½œé‡è¯æ˜` )ã€‚å¦å¤–ï¼ŒåŒºå—é“¾æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå…¶æ²¡æœ‰å•ä¸€çš„å†³ç­–è€…ã€‚å› æ­¤ï¼Œä¸€ä¸ªæ–°çš„åŒºå—å¿…é¡»å¾—åˆ°ç½‘ç»œçš„å…¶ä»–å‚ä¸è€…çš„ç¡®è®¤å’ŒåŒæ„ï¼ˆè¿™ç§æœºåˆ¶è¢«ç§°ä¸ºå…±è¯†ï¼‰ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬çš„åŒºå—é“¾è¿˜æ²¡æœ‰äº¤æ˜“ï¼

åœ¨ä»¥åçš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»è¿™äº›åŠŸèƒ½ã€‚

é“¾æ¥ï¼š
1.è·å–æºç ï¼š[https://github.com/Jeiwan/blockchain_go/tree/part_1](https://github.com/Jeiwan/blockchain_go/tree/part_1)
2.åŒºå—å“ˆå¸Œç®—æ³•ï¼š[httpsï¼š//en.bitcoin.it/wiki/Block_hashing_algorithm](httpsï¼š//en.bitcoin.it/wiki/Block_hashing_algorithm)





