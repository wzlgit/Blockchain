### 搭建以太坊私有链和联盟链

#### 1、区块链类型

根据区块链的网络类型分类，目前区块链主要分为三种类型，即共有链、私有链和联盟链。

1、共有链(Public Blockchain)：对所有人开放，各参与者（即节点）可自由加入以及退出网络，所有数据公开透明，通常被认为是真正意义上的完全去中心化的区块链，如比特币、以太坊、EOS等。

共有链又分为主网和测试网络。
主网（MainNet）：正式上线的区块链网路，主网上线才代表这是一个真正的区块链。
很多项目都在筹备着主网上线，如IPFS、EOS等，正所谓上主网必大涨。

测试网络（TestNet）：专门给用户用来开发、测试和调试用的区块链网络。
如在以太坊平台，目前在运行的测试网络有三个，分别是Ropsten、Kovan和Rinkeby。在测试网络，以太币价值更低，也更容易得到。

2、私有链（Private Blockchain）：写入权限有由某个组织或者机构全权控制，参与节点的资格会被严格限制。参与的节点有限和可控，因此其主要特点是极快的交易速度、更低的交易成本、更好的隐私保护、不容易被恶意篡改。

3、联盟链（Consortium Blockchain）：由若干个机构共同参与管理，若干个机构共同参与管理，每个机构都运行着一个或多个节点，其中的数据只允许系统内不同的机构进行读写和发送交易，并且共同来记录交易数据，如Hyperledger、R3 Corda等。

以下，演示如何在以太坊平台搭建私有链和联盟链。
**注意：以下操作均在MacOS上面操作**

#### 2、搭建私有链
在私有链进行开发和测试不需要同步共有链大量的区块数据，也不需要花钱购买以太币，可以通过模拟挖矿获取以太币。

##### 2.1 安装前提

1、安装Homebrew：

```
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```

2、安装Go：

```
brew install go
```

检查安装版本

```
wenzildeiMac:~ wenzil$ go version
go version go1.9.2 darwin/amd64
```

下载Go之后，需要配置下系统环境变量，这里不作描述。

3、安装Go-Ethereum客户端（安装Geth
方法一，推荐）：

geth是以太坊的官方客户端，提供很多命令和选项，可以运行以太坊节点、创建和管理账户、发送交易、挖矿、部署智能合约到区块链等。

安装命令：

```
brew tap ethereum/ethereum
brew install ethereum
```

```
##########之前安装过，显示可能不一样##########
wenzildeiMac:private-chain-data wenzil$ brew tap ethereum/ethereum
Updating Homebrew...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==> Updated Formulae
logcheck

wenzildeiMac:private-chain-data wenzil$ brew install ethereum  
Updating Homebrew...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==> Updated Formulae
hopenpgp-tools

==> Downloading https://homebrew.bintray.com/bottles/ethereum-1.8.10.high_

##########此处省略多行输出内容##########
==> Pouring ethereum-1.8.10.high_sierra.bottle.tar.gz
🍺  /usr/local/Cellar/ethereum/1.8.10: 18 files, 204MB

##########检查版本号##########
wenzildeiMac:private-chain-data wenzil$ geth version
Geth
Version: 1.8.10-stable
Architecture: amd64
Protocol Versions: [63 62]
Network Id: 1
Go Version: go1.10.2
Operating System: darwin
GOPATH=/usr/local/Cellar/go/1.10.2
GOROOT=/usr/local/Cellar/go/1.10.2/libexec                     
```

4、安装Geth命令行工具（安装Geth方法二，比方法一稍微麻烦一点）：

也可以通过Github下载源码进行编译，Github地址：

```
https://github.com/ethereum/go-ethereum.git
```

下载成功后，需要手动编译：

```
wenzildeiMac:go-ethereum wenzil$ pwd
/Users/wenzil/Desktop/study/go-ethereum
wenzildeiMac:go-ethereum wenzil$ make geth
build/env.sh go run build/ci.go install ./cmd/geth
>>> /usr/local/Cellar/go/1.10.2/libexec/bin/go install -ldflags -X main.gitCommit=1da33028ce88c4365d99471977098f4911fd38fa -s -v ./cmd/geth
github.com/ethereum/go-ethereum/common/hexutil
github.com/ethereum/go-ethereum/vendor/github.com/hashicorp/golang-lru/simplelru
##########此处省略多行输出内容##########
github.com/ethereum/go-ethereum/cmd/geth
Done building.
Run "/Users/wenzil/Desktop/study/go-ethereum/build/bin/geth" to launch geth.

wenzildeiMac:go-ethereum wenzil$ make all
build/env.sh go run build/ci.go install
>>> /usr/local/Cellar/go/1.10.2/libexec/bin/go install -ldflags -X main.gitCommit=1da
##########此处省略多行输出内容##########
github.com/ethereum/go-ethereum/whisper/shhclient
github.com/ethereum/go-ethereum/whisper/whisperv5

##########检查版本号##########
wenzildeiMac:go-ethereum wenzil$ ./build/bin/geth version
Geth
Version: 1.8.7-unstable
Git Commit: 1da33028ce88c4365d99471977098f4911fd38fa
Architecture: amd64
Protocol Versions: [63 62]
Network Id: 1
Go Version: go1.10.2
Operating System: darwin
GOPATH=/usr/local/Cellar/go/1.10.2
GOROOT=/usr/local/Cellar/go/1.10.2/libexec
```

5、安装Solidity编译器：
Solidity是一个面向合约的高级语言,其语法类似于JavaScript，以太坊的智能合约使用的是Solidity语言。

```
wenzildeiMac:~ wenzil$ brew install solidity
==> Installing solidity from ethereum/ethereum
==> Installing dependencies for ethereum/ethereum/solidity: cmake, z3
==> Installing ethereum/ethereum/solidity dependency: cmake
==> Downloading https://homebrew.bintray.com/bottles/cmake-3.11.2.high_sierra.bo
######################################################################## 100.0%
==> Pouring cmake-3.11.2.high_sierra.bottle.tar.gz
##########此处省略多行输出内容##########
==> Downloading https://github.com/ethereum/solidity/releases/download/v0.4.24/s
==> Downloading from https://github-production-release-asset-2e65be.s3.amazonaws
######################################################################## 100.0%
==> cmake . -DCMAKE_C_FLAGS_RELEASE=-DNDEBUG -DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG 
==> make install
🍺  /usr/local/Cellar/solidity/0.4.24: 6 files, 5.5MB, built in 3 minutes 33 seconds
```

注意：下载和安装比较慢，可以会失败，重新执行"brew install solidity"命令即可。

##### 2.2 创建以太坊私有链

一般来说，都是不同的电脑（节点）组成私有链。这里为了方便，演示如何在同一台电脑搭建以太坊私有链。

1、创建用于保存私有链数据的文件夹

```
wenzildeiMac:go-ethereum wenzil$ pwd
/Users/wenzil/Desktop/study/go-ethereum
wenzildeiMac:go-ethereum wenzil$ cd ..
wenzildeiMac:study wenzil$ pwd
/Users/wenzil/Desktop/study
wenzildeiMac:study wenzil$ mkdir private-chain-data
wenzildeiMac:study wenzil$ cd private-chain-data/
```

使用geth命令启动私有链节点：

```
geth --networkid 123 --dev --datadir data1 --rpc --rpcaddr 192.168.xxx.xxx --rpcport 8989 --port 3000

--identity：指定节点 ID；
--rpc：表示开启 HTTP-RPC 服务；
--rpcaddr：HTTP-RPC 服务ip地址；
--rpcport：指定 HTTP-RPC 服务监听端口号（默认为 8545）；
--datadir：指定区块链数据的存储位置；
--port：指定和其他节点连接所用的端口号（默认为 30303）；
--nodiscover：关闭节点发现机制，防止加入有同样初始配置的陌生节点

192.168.xxx.xxx为对应的IP地址
```

在命令行输入：

```
geth --networkid 123 --dev --datadir data1 --rpc --rpcaddr 192.168.6.31 --rpcport 8989 --port 3000
```

192.168.6.31替换为你的IP地址。

```
wenzildeiMac:private-chain-data wenzil$ geth --networkid 123 --dev --datadir data1 --rpc --rpcaddr 192.168.6.31 --rpcport 8989 --port 3000
INFO [05-31|19:29:05] Maximum peer count                       ETH=25 LES=0 total=25
INFO [05-31|19:29:07] Using developer account                  address=0x84497a30D1f54E11D2bfE7bae56edb8144B6dd9D
INFO [05-31|19:29:07] Starting peer-to-peer node               instance=Geth/v1.8.10-stable/darwin-amd64/go1.10.2
INFO [05-31|19:29:07] Allocated cache and file handles         database=/Users/wenzil/Desktop/study/private-chain-data/data1/geth/chaindata cache=768 handles=128
INFO [05-31|19:29:07] Writing custom genesis block 
INFO [05-31|19:29:07] Persisted trie from memory database      nodes=11 size=2.17kB time=58.535µs gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
INFO [05-31|19:29:07] Initialised chain configuration                    versions="[63 62]" network=123
##########此处省略多行输出内容##########INFO [05-31|16:29:07] Commit new mining work                   number=1 txs=0 uncles=0 elapsed=71.562µs
WARN [05-31|19:29:07] Block sealing failed                     err="waiting for transactions"

```

打开"private-chain-data"文件夹，会发现多了几个文件。
![1.运行节点自动生成文件](media/15277374610223/1.%E8%BF%90%E8%A1%8C%E8%8A%82%E7%82%B9%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6.png)

##### 2.3 使用JavaScript Console交互

可以进入JavaScript Console执行环境，使用里面的内置对象做一些操作，这些内置对象提供的功能很丰富，比如查看区块和交易、创建账户、挖矿、发送交易、部署智能合约等。

```
geth attach ipc:<data1>/geth.ipc

eth：包含一些跟操作区块链相关的方法；
net：包含一些查看p2p网络状态的方法；
admin：包含一些与管理节点相关的方法；
miner：包含启动&停止挖矿的一些方法；
personal：主要包含一些管理账户的方法；
txpool：包含一些查看交易内存池的方法；
web3：包含了以上对象，还包含一些单位换算的方法。
```


保持私有链节点的运行，打开新的终端，操作如下：

```
wenzildeiMac:~ wenzil$ geth attach ipc:/Users/wenzil/Desktop/study/private-chain-data/data1/geth.ipc
Welcome to the Geth JavaScript console!

instance: Geth/v1.8.10-stable/darwin-amd64/go1.10.2
coinbase: 0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d
at block: 0 (Thu, 01 Jan 1970 08:00:00 CST)
 datadir: /Users/wenzil/Desktop/study/private-chain-data/data1
 modules: admin:1.0 clique:1.0 debug:1.0 eth:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 shh:1.0 txpool:1.0 web3:1.0

> eth.accounts
["0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d"]
> personal.newAccount("wenzil")
"0xc81f9f0561a0820483ce9a9dec621bb6667dbfa6"
> personal.listAccounts
["0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d", "0xc81f9f0561a0820483ce9a9dec621bb6667dbfa6"]
> eth.accounts
["0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d", "0xc81f9f0561a0820483ce9a9dec621bb6667dbfa6"]
> web3.eth.coinbase
"0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d"
> personal.listAccounts[0]
"0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d"
> eth.getBalance(personal.listAccounts[0])
1.15792089237316195423570985008687907853269984665640564039457584007913129639927e+77
> eth.getBalance(personal.listAccounts[1])
0

> web3.fromWei(eth.getBalance(personal.listAccounts[0]).toNumber(), 'ether');
"115792089237316200000000000000000000000000000000000000000000"
> web3.fromWei(eth.getBalance(personal.listAccounts[1]).toNumber(), 'ether');
"0"

###发送转账交易，返回交易的哈希###
> sendEther = web3.toWei(5, 'ether');
> eth.sendTransaction({from: web3.eth.coinbase, to:personal.listAccounts[1], value:sendEther})
"0x70b014b7ded02aadb2e78c48e1ab8762694ffb82d0189e180b14318ec8455cd7"
###查看交易的状态###
> txpool.status
{
  pending: 1,
  queued: 0
}
> miner.start()
null
> miner.stop()
true
> txpool.status

{
  pending: 0,
  queued: 0
}
###发现转账成功###
> web3.fromWei(eth.getBalance(personal.listAccounts[1]).toNumber(), 'ether');
"5"
> eth.blockNumber
1
> eth.getTransaction("0x70b014b7ded02aadb2e78c48e1ab8762694ffb82d0189e180b14318ec8455cd7")
{
  blockHash: "0x07944f163f2bdb4f49ee870dd39175e2f1010ef4b8871eb3a3447916d186dee2",
  blockNumber: 1,
  from: "0x84497a30d1f54e11d2bfe7bae56edb8144b6dd9d",
  gas: 90000,
  gasPrice: 1,
  hash: "0x70b014b7ded02aadb2e78c48e1ab8762694ffb82d0189e180b14318ec8455cd7",
  input: "0x",
  nonce: 0,
  r: "0x2865f45643c43abd258c2fd12b2a3187d4ad98c4dfda9bd2804e92f78fd0c803",
  s: "0x4923415a88799ab3d3c7cf0d41bc2b9cedaa033c346cf41a229eff3703b1d7f8",
  to: "0xc81f9f0561a0820483ce9a9dec621bb6667dbfa6",
  transactionIndex: 0,
  v: "0xa96",
  value: 5000000000000000000
}
> eth.getBlock(1)
{
  difficulty: 2,
  extraData: "0xd98301080a846765746888676f312e31302e328664617277696e000000000000b3e4f8e50c4c8d1b9ccfda57ca557cf86b41220ffbefb38956621c6a716afb5547c7a4852494ee16ec0d9ff4f5352307659babdc8b5e57c604852c2c2a3a996301",
  gasLimit: 6277051,
  gasUsed: 21000,
  hash: "0x07944f163f2bdb4f49ee870dd39175e2f1010ef4b8871eb3a3447916d186dee2",
  logsBloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  miner: "0x0000000000000000000000000000000000000000",
  mixHash: "0x0000000000000000000000000000000000000000000000000000000000000000",
  nonce: "0x0000000000000000",
  number: 1,
  parentHash: "0x66bcc11d1680c2d52d09aa6f113d4306f089728598202467cbde72213f12a0ae",
  receiptsRoot: "0x056b23fbba480696b65fe5a59b8f2148a1299103c4f57df839233af2cf4ca2d2",
  sha3Uncles: "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
  size: 717,
  stateRoot: "0xf4c4362504f7b2eacff4ed57dc82f578f275ff49a6f644ddc4062b3b7a3cf935",
  timestamp: 1527759405,
  totalDifficulty: 3,
  transactions: ["0x70b014b7ded02aadb2e78c48e1ab8762694ffb82d0189e180b14318ec8455cd7"],
  transactionsRoot: "0x8c3c2e1e0a536874aafd9d40f09d1519c5537dceff0dbd28d9ba6118d37dea7b",
  uncles: []
}
> 
> miner.setEtherbase(eth.accounts[1])
true
> eth.getBalance(eth.coinbase)
5000000000000000000
> web3.fromWei(eth.getBalance(eth.coinbase))
5

```

对应命令说明:
eth.accounts // 查询账号列表
personal.listAccounts //查询账号列表
personal.newAccount("xxx") //新建账号，xxx为账户账号
web3.eth.coinbase // 节点挖矿的账号地址，默认为账号列表的第一个账号
personal.listAccounts[0] // 查看账号列表的第一个账号
eth.getBalance("xxx") //查看对应账号的余额，xxx为账号地址
miner.start()       // 开始挖矿
miner.stop()        // 停止挖矿
txpool.status       // 查看交易的状态
eth.blockNumber     // 查看交易的区块号
eth.getTransaction  // 查看交易区块信息
eth.getBlock(xxx)    // 根据区块号查看区块信息，xxx为区块号
miner.setEtherbase(xxx)    // 设置挖矿的账号，xxx为账号地址
getBalance()   // 返回值的单位是wei，wei是以太币的最小单位，1个以太币=10的18次方个wei。要查看有多少个以太币，可以用web3.fromWei()将返回值换算成以太币

##### 2.4 创建私有链集群



#### 3、搭建联盟链

